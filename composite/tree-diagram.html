<style>
    body {
        margin: 0;
        padding: 0;
    }
</style>

<canvas id="canvas"></canvas>

<script>

    class TreeBuilder {
        buildFromRepresentation(representation, context) {
            const root = this._buildNodesFromRepresentation(representation, undefined, context)
            return new Tree(root)
        }

        _buildNodesFromRepresentation(representation, parentNode, context) {
            let node;
            if (representation.children) {
                node = new CompositeNode(representation.id, representation.x || 0, representation.y || 0, context)
                representation.children.forEach(childRepresentation => {
                    this._buildNodesFromRepresentation(childRepresentation, node, context)
                })
            } else {
                node = new Node(representation.id, representation.x || 0, representation.y || 0, context)
            }

            if (parentNode) {
                parentNode.addChild(node)
            }

            return node
        }
    }

    class Tree {
        constructor(root) {
            this._root = root
        }

        draw() {
            this._root.draw()
        }
    }

    class Node {
        constructor(
            id,
            x = undefined,
            y = undefined,
            context
        ) {
            if (!id) {
                throw new Error(`node: invalid id: ${id}`)
            }
            this.id = id

            this.setPosition(x, y)
            
            if (!context) {
                throw new Error(`node ${id}: invalid context: ${context}`)
            }
            this.context = context


            this.children = []
            this.parent = undefined
        }

        setPosition(x, y) {
            if (x === undefined) {
                throw new Error(`node ${this.id}: x is required`)
            }
            if (y === undefined) {
                throw new Error(`node ${this.id}: y is required`)
            }

            this.x = x
            this.y = y
        }

        setParent(parent) {
            if (!parent) {
                throw new Error(`node ${this.id}: invalid parent: ${parent}`)
            }
            this.parent = parent
        }

        addChild(child) {
            throw new Error(`node ${this.id}: addChild not implemented`)
        }

        draw() {
            this.context.fillText(this.id, this.x, this.y)

            if (this.parent) {
                this._drawConnectionToParent()
            }
        }

        _drawConnectionToParent() {
            const c = this.context
            c.beginPath()

            const glyphHeight = 8
            const glyphMargin = 5
            const offsetToCenterOfGlyph = 3
            c.moveTo(this.x + offsetToCenterOfGlyph, this.y - glyphHeight - glyphMargin)
            c.lineTo(this.parent.x + offsetToCenterOfGlyph, this.parent.y + glyphMargin)

            c.closePath()
            c.stroke()
        }

    }

    class CompositeNode extends Node {
        addChild(child) {
            if (!child) {
                throw new Error(`composite node ${this.id}: invalid child: ${child}`)
            }
            this.children.push(child)
            child.setParent(this)
        }

        draw() {
            super.draw()
            this.children.forEach(child => child.draw())
        }
    }

    class CompositeTreeTests {
        testCompositeNodeWithChildRenders(ctx) {
            const c = new Node('c', 200, 200, ctx)
            const b = new Node('b', 100, 200, ctx)
            const a = new CompositeNode('a', 100, 100, ctx)
            a.addChild(b)
            a.addChild(c)

            a.draw()
        }

        testTreeRenders(ctx) {
            const c = new Node('c', 200, 200, ctx)
            const b = new Node('b', 100, 200, ctx)
            const a = new CompositeNode('a', 100, 100, ctx)
            a.addChild(b)
            a.addChild(c)
            const t = new Tree(a)

            t.draw()
        }

        testTreeBuiltFromObjectRenders(ctx) {
            const treeRepresentation = {
                id: 'a',
                x: 300,
                y: 50,
                children: [
                    {
                        id: 'b',
                        x: 325,
                        y: 100,
                        children: [
                            {
                                id: 'd',
                                x: 400,
                                y: 150,
                                children: [
                                    {
                                        id: 'f',
                                        x: 375,
                                        y: 200,
                                    },
                                    {
                                        id: 'g',
                                        x: 425,
                                        y: 200,
                                        children: [
                                            {
                                                id: 'h',
                                                x: 450,
                                                y: 250,
                                            },
                                            {
                                                id: 'i',
                                                x: 400,
                                                y: 250,
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                id: 'e',
                                x: 300,
                                y: 150,
                            }
                        ]
                    },
                    {
                        id: 'c',
                        x: 275,
                        y: 100,
                    }
                ]
            }

            const t = new TreeBuilder().buildFromRepresentation(treeRepresentation, ctx)
            t.draw()
        }
    }

    const canvas = document.getElementById('canvas')
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight
    const ctx = canvas.getContext('2d')

    new CompositeTreeTests().testTreeBuiltFromObjectRenders(ctx);


</script>